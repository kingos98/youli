//
//  ViewController.m
//  youli
//
//  Created by jun on 9/18/12.
//  Copyright (c) 2012 __MyCompanyName__. All rights reserved.
//

#import "AFJSONRequestOperation.h"
#import "UIImageView+WebCache.h"
#import "IndexController.h"
#import "BirthdayController.h"
#import "PersonalController.h"

@interface IndexController ()

@end

@implementation IndexController

@synthesize items;
@synthesize templateForIphone4;

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    templateForIphone4 = [[NSArray alloc] initWithObjects:
    [NSArray arrayWithObjects:@"4",@"4",@"207",@"102",@"small",nil],
    [NSArray arrayWithObjects:@"214",@"4",@"102",@"102",@"small",nil],
    [NSArray arrayWithObjects:@"4",@"109",@"102",@"102",@"small",nil],
    [NSArray arrayWithObjects:@"109",@"109",@"207",@"207",@"big",nil],
    [NSArray arrayWithObjects:@"4",@"213",@"102",@"207",@"small",nil],
    [NSArray arrayWithObjects:@"109",@"317",@"102",@"102",@"small",nil],
    [NSArray arrayWithObjects:@"214",@"317",@"102",@"102",@"small",nil],nil];
    
    //类别view，可向右滑动，初始化时处于第一层，相当于被隐藏。
    categoryView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 212, 460)];
    
    //添加分类页面
    categoryTableView = [[CategoryTableView alloc] initWithFrame:CGRectMake(0, 0, 212, 460)];
    [categoryView addSubview:categoryTableView];
    
    UITapGestureRecognizer *singleTap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(handleCategoryTap:)];
    [categoryTableView addGestureRecognizer:singleTap];

    
    mainScrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 0, 320, 480)];
    mainScrollView.backgroundColor = [UIColor whiteColor];
    mainScrollView.showsVerticalScrollIndicator = NO;
    CGSize size = mainScrollView.frame.size;
    [mainScrollView setContentSize:CGSizeMake(size.width, size.height * 2)];
    [self loadDataSource];
    
   
    UIImageView *tabBarBgView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 422, 320, 38)];
    [tabBarBgView setImage:[UIImage imageNamed:@"tabbar_bg.png"]];
    
    UIButton *tabBarLeftButton = [UIButton buttonWithType:UIButtonTypeCustom];
    UIImage *tabBarLeftImage = [[UIImage imageNamed:@"tabbar_left.png"] stretchableImageWithLeftCapWidth:0 topCapHeight:0];
    tabBarLeftButton.frame = CGRectMake(0, 422, 78, 38);
    [tabBarLeftButton setBackgroundImage:tabBarLeftImage forState:UIControlStateNormal];
    [tabBarLeftButton addTarget:self action:@selector(showCategoryViewPressed) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *tabBarBoxButton = [UIButton buttonWithType:UIButtonTypeCustom];
    UIImage *tabBarBoxImage = [[UIImage imageNamed:@"tabbar_box.png"] stretchableImageWithLeftCapWidth:0 topCapHeight:0];
    tabBarBoxButton.frame = CGRectMake(120, 414, 78, 45);
    [tabBarBoxButton setBackgroundImage:tabBarBoxImage forState:UIControlStateNormal];
    [tabBarBoxButton addTarget:self action:@selector(birthdayButtonPressed) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *tabBarRightButton = [UIButton buttonWithType:UIButtonTypeCustom];
    UIImage *tabBarRightImage = [[UIImage imageNamed:@"tabbar_right.png"] stretchableImageWithLeftCapWidth:0 topCapHeight:0];
    tabBarRightButton.frame = CGRectMake(240, 422, 78, 38);
    [tabBarRightButton setBackgroundImage:tabBarRightImage forState:UIControlStateNormal];
    [tabBarRightButton addTarget:self action:@selector(personalButtonPressed) forControlEvents:UIControlEventTouchUpInside];
    
    //加到父view中的子view是按顺序加载的，需注意加载子view的顺序！
    [self.view addSubview:categoryView];
    [self.view addSubview:mainScrollView];
    [mainScrollView addSubview:tabBarBgView];
    [mainScrollView addSubview:tabBarLeftButton];
    [mainScrollView addSubview:tabBarBoxButton];
    [mainScrollView addSubview:tabBarRightButton];
}


- (void)showCategoryViewPressed
{
    [UIView beginAnimations:nil context:NULL];
    [UIView setAnimationDuration:0.3];
    CGPoint point = mainScrollView.center;
    if(isPopCategoryView)
    {
        mainScrollView.center = CGPointMake(point.x-212,point.y);
        isPopCategoryView = false;
    }
    else
    {
        mainScrollView.center = CGPointMake(point.x+212,point.y);
        isPopCategoryView = true;
    }
    [UIView commitAnimations];
}

- (void)birthdayButtonPressed
{
    BirthdayController *birthdayController = [[BirthdayController alloc] init];
    [self.navigationController pushViewController:birthdayController animated:NO];
}

- (void)personalButtonPressed
{
    PersonalController *personalController = [[PersonalController alloc] init];
    [self.navigationController pushViewController:personalController animated:NO];
}

-(void)viewDidAppear:(BOOL)animated
{
    [self.navigationController setNavigationBarHidden:YES animated:NO];
}

- (void)viewDidUnload
{
    [super viewDidUnload];
}

- (void)loadDataSource{
    NSURLRequest *request = [NSURLRequest requestWithURL:[NSURL URLWithString:@"http://imgur.com/gallery.json"]];
    AFJSONRequestOperation *operation = [AFJSONRequestOperation JSONRequestOperationWithRequest:request
    success:^(NSURLRequest *request, NSHTTPURLResponse *response, id JSON) {
        self.items = [JSON objectForKey:@"data"];
        for (int i=0; i<7; i++) {
            NSDictionary *item = [self.items objectAtIndex:i];                                                
            NSURL *URL = [NSURL URLWithString:[NSString stringWithFormat:@"http://imgur.com/%@%@",[item objectForKey:@"hash"], [item objectForKey:@"ext"]]];                                                 
            NSString *x = [[templateForIphone4 objectAtIndex:i] objectAtIndex:0];
            NSString *y = [[templateForIphone4 objectAtIndex:i] objectAtIndex:1];
            NSString *width = [[templateForIphone4 objectAtIndex:i] objectAtIndex:2];
            NSString *height = [[templateForIphone4 objectAtIndex:i] objectAtIndex:3];
            UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake([x intValue],
                                                                                   [y intValue],
                                                                                   [width intValue],
                                                                                   [height intValue])];                                                 
            [imageView setImageWithURL:URL placeholderImage:[UIImage imageNamed:@"3.jpg"]];
            [mainScrollView addSubview:imageView];

            imageView = nil; 
        }
    }failure:^(NSURLRequest *request, NSHTTPURLResponse *response, NSError *error, id JSON) {
         NSLog(@"error: %@", error);
    }];
    [operation start];
}

- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation
{
    if ([[UIDevice currentDevice] userInterfaceIdiom] == UIUserInterfaceIdiomPhone) {
        return (interfaceOrientation != UIInterfaceOrientationPortraitUpsideDown);
    } else {
        return YES;
    }
}

- (void) handleCategoryTap:(UITapGestureRecognizer *) gestureRecognizer{
//    [self showCategoryViewPressed];
}

@end
